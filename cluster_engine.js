const { google } = require('googleapis');\nconst { GoogleGenerativeAI } = require('@google/generative-ai');\nconst fs = require('fs');\nconst axios = require('axios');\nconst FormData = require('form-data');\n\nconst MASTER_GUIDELINE = ` + sanitizedGuideline + `;\nconst NARRATIVE_HINTS = ` + narrativeLibrary + `;\n\nconst STYLE = `<style>\n  @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700&family=Pretendard:wght@400;700&display=swap');\n  .vue-premium { font-family: 'Pretendard', sans-serif; color: #333; line-height: 2.1; font-size: 17px; letter-spacing: -0.5px; max-width: 880px; margin: 0 auto; padding: 25px; word-break: keep-all; }\n  .vue-premium p { margin-bottom: 25px; }\n  .vue-premium h2 { border-radius: 12px; color: #000; font-size: 26px; font-weight: bold; margin-top: 60px; padding: 20px; border-left: 12px solid #222; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }\n  .vue-premium h3 { font-size: 22px; font-weight: bold; margin-top: 45px; margin-bottom: 20px; color: #333; padding-bottom: 10px; border-bottom: 2px solid #eee; }\n  .toc-box { background-color: #fafafa; border: 1px solid #eee; border-radius: 20px; padding: 35px; margin: 40px 0; box-shadow: inset 0 2px 10px rgba(0,0,0,0.01); }\n  .vue-premium table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 40px 0; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.05); border: 1px solid #eee; }\n  .vue-premium th { background-color: #333; color: #fff; padding: 20px; font-weight: bold; }\n  .vue-premium td { padding: 18px; border-bottom: 1px solid #f0f0f0; background-color: #fff; color: #444; }\n  .vue-premium tip-box { border-left: 6px solid #333; padding: 25px; margin: 35px 0; border-radius: 0 15px 15px 0; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }\n  .spacer-div { height: 70px; }\n</style>`;\n\nfunction clean(raw, defType = 'obj') {\n    if(!raw) return defType === 'text' ? '' : (defType === 'obj' ? '{}' : '[]');\n    let t = raw.replace(/```(json|html|javascript|js)?/gi, '').trim();\n    if (defType === 'text') {\n        t = t.replace(/<(!DOCTYPE|html|body|head|meta|link).*?>/gi, '').replace(/<\/(html|body|head|title|meta)>/gi, '');\n        t = t.replace(/<title[\s\S]*?<\/title>/gi, '');\n        t = t.replace(/\*\*+(.*?)\*\*+/g, '<b>$1</b>');\n        t = t.replace(/\[(EDITORIAL|ì‹œí–‰ì§€ì¹¨|ê°€ì´ë“œë¼ì¸|RULE|V-LOGIC|ì—°ê³„.*?)\]/gi, '');\n        t = t.replace(/íŒ¨í„´\s*[A-O](\s*(.*?))?(:)?/gi, '');\n        t = t.replace(/^(ì„œë¡ |ë³¸ë¡ |ê²°ë¡ |ë¶€ë¡|ì£¼ì˜|ì°¸ê³ |Introduction|Summary|Conclusion|ì£¼ì˜|ë‚ ì§œ|ì¥|ì ˆ|ì±•í„°\s*\d+|ì„¹ì…˜\s*íƒ€ì´í‹€|í•µì‹¬\s*ìš”ì•½|í•´ê²°ì±…|FAQ)[:\s]*/gmi, '');\n        t = t.replace(/^#{1,6}\s+.*$/gm, '');\n        t = t.replace(/<script type="application\/ld\+json">[\s\S]*?<\/script>/gi, '');\n        t = t.replace(/IMG_\d+:\s*\{[\s\S]*?\}/gi, '');\n        t = t.replace(/^[ğŸ”—ğŸ“ğŸ·ğŸ“ğŸ–¼\#\>].*$/gm, '');\n        t = t.replace(/^(Part|Mission|Trinity Mission|íŠ¸ë¦¬ë‹ˆí‹° ë¯¸ì…˜).*/gmi, '');\n        return t.trim();\n    }\n    try {\n        const start = t.indexOf('{'), end = t.lastIndexOf('}');\n        const startArr = t.indexOf('['), endArr = t.lastIndexOf(']');\n        let jsonStr = '';\n        if (defType === 'obj' && start !== -1 && end !== -1) jsonStr = t.substring(start, end + 1);\n        else if (defType === 'arr' && startArr !== -1 && endArr !== -1) jsonStr = t.substring(startArr, endArr + 1);\n        if (jsonStr) {\n            jsonStr = jsonStr.replace(/[\r\n\t]/g, ' ').replace(/[^\x20-\x7E\u00A0-\uFFFF]/g, '');\n            try { JSON.parse(jsonStr); return jsonStr; } catch(pe) { return defType === 'obj' ? '{}' : '[]'; }\n        }\n    } catch(e) { }\n    return defType === 'obj' ? '{}' : '[]';\n}\n\nasync function callAI(model, prompt, retry = 0) {\n    try {\n        const r = await model.generateContent('[SYSTEM: ACT AS A TOP-TIER COLUMNIST. STRICTLY FOLLOW GOOGLE E-E-A-T. NO CHAT.]\n' + prompt);\n        const cand = r.response.candidates?.[0];\n        if (cand?.finishReason === 'SAFETY' || cand?.finishReason === 'RECITATION') {\n            return 'ì•ˆì „ìƒì˜ ë¬¸ì œë¡œ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';\n        }\n        return r.response.text().trim();\n    } catch (e) {\n        if (String(e.message).includes('429') && retry < 7) {\n            await new Promise(res => setTimeout(res, Math.pow(2, retry) * 20000));\n            return callAI(model, prompt, retry + 1);\n        }\n        return 'ì˜¤ë¥˜ ë°œìƒ.';\n    }\n}\nasync function searchSerper(query) {\n    if(!process.env.SERPER_API_KEY) return '';\n    console.log('   ğŸ” [Search] Google ê²€ìƒ‰ ì‹œë„: ' + query);\n    try {\n        const r = await axios.post('https://google.serper.dev/search', { q: query, gl: 'kr', hl: 'ko' }, { headers: { 'X-API-KEY': process.env.SERPER_API_KEY } });\n        const snippets = r.data.organic.slice(0, 5).map(o => o.title + ': ' + o.snippet).join('\n');\n        console.log('   âœ… [Search] ê²€ìƒ‰ ê²°ê³¼ ìˆ˜ì§‘ ì™„ë£Œ (' + r.data.organic.length + 'ê°œ)');\n        return snippets;\n    } catch(e) { console.log('   âŒ [Search] ê²€ìƒ‰ ì‹¤íŒ¨'); return ''; }\n}\nasync function genImg(desc, model, i) {\n    if(!desc) return '';\n    console.log('   ğŸ¨ [Image] ì´ë¯¸ì§€ ' + i + 'ë²ˆ ì‹œê°í™” í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...');\n    let engPrompt = '';\n    try {\n        const engPromptRes = await callAI(model, 'Translate visual description to English for image generation. NO CHAT: ' + desc);\n        engPrompt = engPromptRes.replace(/[^a-zA-Z0-9, ]/g, '').trim();\n    } catch(e) { engPrompt = desc; }\n    if(!engPrompt || engPrompt === 'ì˜¤ë¥˜ ë°œìƒ.') engPrompt = desc;\n    let imageUrl = `https://image.pollinations.ai/prompt/` + encodeURIComponent(engPrompt) + `?width=1280&height=720&nologo=true&seed=` + Math.floor(Math.random()*1000000) + `&model=flux`;\n    const imgbbKey = process.env.IMGBB_API_KEY;\n    if(imgbbKey) {\n        console.log('   â˜ï¸ [Image] ImgBB ì˜êµ¬ ì €ì¥ì†Œì— ì—…ë¡œë“œ ì‹œë„...');\n        try {\n            const res = await axios.get(imageUrl, { responseType: 'arraybuffer' });\n            const form = new FormData(); form.append('image', Buffer.from(res.data).toString('base64'));\n            const ir = await axios.post('https://api.imgbb.com/1/upload?key=' + imgbbKey, form, { headers: form.getHeaders() });\n            console.log('   âœ… [Image] ImgBB ì—…ë¡œë“œ ì„±ê³µ: ' + ir.data.data.url);\n            return ir.data.data.url;\n        } catch(e) { console.log('   âš ï¸ [Image] ImgBB ì—…ë¡œë“œ ì‹¤íŒ¨, ì›ë³¸ ë§í¬ ì‚¬ìš©'); }\n    }\n    return imageUrl;\n}\nasync function writeAndPost(model, target, lang, blogger, bId, pTime, extraLinks = [], idx, total) {\n    console.log('   ğŸ“ [Draft] ë¸”ë¡œê·¸ ê¸°íš ì‹œì‘: ' + target);\n    const searchData = await searchSerper(target);\n    const bpPrompt = 'Return ONLY valid JSON with title and 7 chapters for: ' + target + '. Format: {title:string, chapters:[7 strings]}. No markdown, no explanation.';\n    const bpRes = await callAI(model, bpPrompt);\n    let data = {};\n    try { data = JSON.parse(clean(bpRes, 'obj') || '{}'); } catch(e) { console.log('   âš ï¸ Blueprint parse fail, using fallback'); data = {}; }\n    const title = data.title || target;\n    if(!data.chapters || !data.chapters.length) { try { const c2 = await callAI(model, 'Generate 7 short Korean subtitles for: ' + target + '. Return JSON array only.'); data.chapters = JSON.parse(clean(c2, 'arr') || '[]'); } catch(e2) { data.chapters = []; } }\n    const chapters = Array.isArray(data.chapters) ? data.chapters : [];\n    const halfIdx = Math.ceil(chapters.length / 2);\n    const p1Chapters = chapters.slice(0, halfIdx);\n    const p2Chapters = chapters.slice(halfIdx);\n    console.log('   ğŸ“‹ [Draft] ì±•í„° êµ¬ì„± ì™„ë£Œ: ' + chapters.length + 'ê°œ ì„¹ì…˜');\n    \n    console.log('   ğŸš€ [Mission] Trinity Duo 1ë‹¨ê³„ ì‹œì‘ (ì „ë°˜ë¶€)...');\n    const map1 = (extraLinks && extraLinks.length > 0) ? '\n[PILLAR MAPPING]: Use these links at the END of each H2 section.\n' + p1Chapters.map((c, i) => '- H2: "' + c + '" -> Sub: "' + extraLinks[i].title + '" (URL: ' + extraLinks[i].url + ')').join('\n') + '\nButton: <a href="URL" class="internal-link-btn">â” ì‹¬ì¸µ ë¶„ì„: [Sub Title] ìì„¸íˆ ë³´ê¸°</a>' : '';\n    const mission1 = '[íŠ¸ë¦¬ë‹ˆí‹° ë¯¸ì…˜ 1/2ë‹¨ê³„] ' + target + '\n\n1) H1 ì œëª©\n2) ëª©ì°¨\n3) ì„œë¡  (1,200ì ì´ìƒ, ì „ë¬¸ê°€ í†µì°°)\n4) ì„¹ì…˜(H2):\n' + p1Chapters.map(c => '<h2>' + c + '</h2>').join('\n') + '\nâ˜… [í•„ìˆ˜]: H2ë§ˆë‹¤ 4~5ê°œ ë¬¸ë‹¨(P) í•„ìˆ˜. ë¬¸ë‹¨ë§ˆë‹¤ 5ë¬¸ì¥ ì´ìƒ ê½‰ ì°¬ ì„¤ëª… í•„ìˆ˜. ë‹¨ë‹µí˜• ìš”ì•½ ê¸ˆì§€.' + map1;\n    let part1 = await callAI(model, MASTER_GUIDELINE + '\n\n' + mission1 + '\n\n[Search Reference]:\n' + searchData);\n    console.log('   âœ… [Mission] 1ë‹¨ê³„ ì™„ë£Œ (' + part1.length + 'ì)');\n\n    console.log('   ğŸš€ [Mission] Trinity Duo 2ë‹¨ê³„ ì‹œì‘ (í›„ë°˜ë¶€)...');\n    const map2 = (extraLinks && extraLinks.length > 0) ? '\n[PILLAR MAPPING]: Continue linking.\n' + p2Chapters.map((c, i) => '- H2: "' + c + '" -> Sub: "' + extraLinks[halfIdx+i].title + '" (URL: ' + extraLinks[halfIdx+i].url + ')').join('\n') + '\nButton: <a href="URL" class="internal-link-btn">â” ì‹¬ì¸µ ë¶„ì„: [Sub Title] ìì„¸íˆ ë³´ê¸°</a>' : '';\n    const mission2 = '[íŠ¸ë¦¬ë‹ˆí‹° ë¯¸ì…˜ 2/2ë‹¨ê³„] ì´ì–´ì„œ ì‘ì„± (H1/ëª©ì°¨ ì¤‘ë³µ ê¸ˆì§€)\n' + p2Chapters.map(c => '<h2>' + c + '</h2>').join('\n') + '\n1) FAQ (8~10ê°œ ìƒì„¸ ë‹µë³€)\n2) ê²°ë¡  (1,000ì ì´ìƒ, ì „ë¬¸ê°€ ì¡°ì–¸)\nâ˜… [í•„ìˆ˜]: 1ë‹¨ê³„ì™€ ë™ì¼í•œ ê¹Šì´ ìœ ì§€ (H2ë§ˆë‹¤ 4~5ê°œ ë¬¸ë‹¨ ê½‰ ì±„ì›Œ ì‘ì„±).\n- [[IMG_3]], [[IMG_4]] ë°°ì¹˜.\n- [REQUIRED]: ë©”íƒ€ë°ì´í„° ë¸”ë¡(ë¼ë²¨, ê²€ìƒ‰ ì„¤ëª…, ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ IMG_0, IMG_PIN, IMG_1-4) ìƒì„±.' + map2;\n    let part2 = await callAI(model, MASTER_GUIDELINE + '\n\n' + mission2 + '\n\n[Previous Part context]:\n' + part1.substring(part1.length - 1800));\n    let cleanPart2 = part2.replace(/<h1[\s\S]*?<\/h1>/gi, '').replace(/<div class="toc-box">[\s\S]*?<\/div>/gi, '');\n    const firstH2Idx = cleanPart2.search(/<h2[\s>]/i);\n    if (firstH2Idx > 0) cleanPart2 = cleanPart2.substring(firstH2Idx);\n    console.log('   âœ… [Mission] 2ë‹¨ê³„ ì™„ë£Œ (' + part2.length + 'ì)');\n\n    let fullContent = part1 + '\n' + cleanPart2;\n    console.log('   ğŸ“Š [Stat] ì „ì²´ ì›ê³  ìƒì„± ì™„ë£Œ (' + fullContent.length + 'ì)');\n    \n    const disclaimer = "<br><br><div style='font-size:14px; color:#888; border-top:1px solid #eee; padding-top:20px; margin-top:50px;'>* ë³¸ í¬ìŠ¤íŒ…ì€ ì •ë³´ ì œê³µì„ ëª©ì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ì‹¤ì œ ì„œë¹„ìŠ¤ ì´ìš© ì‹œ ê³µì‹ ì±„ë„ì˜ ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. ì½˜í…ì¸ ì˜ ì •í™•ì„±ì„ ê¸°í–ˆìœ¼ë‚˜ ì£¼ê´€ì ì¸ ê²¬í•´ê°€ í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>";\n\n    function getMeta(text, key) {\n      const regex = new RegExp(key + '[\\:\\s]+(.*)', 'i');\n      const match = text.match(regex);\n      return match ? match[1].trim() : '';\n    }\n\n    const labelStr = getMeta(fullContent, 'ğŸ· ë¼ë²¨');\n    const labels = labelStr ? labelStr.split(/[\\,\\s]+/).map(s => s.trim()).filter(s => s.length > 0) : [];\n\n    const imgPrompts = {};\n    const imgRowRegex = /IMG_(\d+):\s*\{?\s*prompt:\s*[\"\'](.*?)[\"\'],\s*alt:\s*[\"\'](.*?)[\"\'],\s*title:\s*[\"\'](.*?)[\"\']\s*\}?/gi;\n    let im; while ((im = imgRowRegex.exec(fullContent)) !== null) {\n        imgPrompts[im[1]] = { prompt: im[2], alt: im[3], title: im[4] };\n    }\n\n    let finalHtml = clean(fullContent, 'text');\n\n    console.log('   ğŸ–¼ [Image] ì´ë¯¸ì§€ ì‚½ì… ë° ìƒì„± í”„ë¡œì„¸ìŠ¤ ì‹œì‘...');\n    for (let i = 1; i <= 4; i++) {\n        const placeholder = "[[IMG_" + i + "]]";\n        if (finalHtml.includes(placeholder)) {\n            let p = imgPrompts[i];\n            if (!p || !p.prompt) {\n                const visualPrompt = await callAI(model, 'Generate a cinematic image prompt (visual only) for a blog about ' + target + ' and subtitle ' + (chapters[i-1] || target) + '. Return ONLY the visual description.');\n                p = { prompt: visualPrompt, alt: target, title: target };\n            }\n            const url = await genImg(p.prompt, model, i);\n            const imgHtml = "<img src='" + url + "' alt='" + p.alt + "' title='" + p.title + "' style='width:100%; border-radius:15px; margin: 30px 0;'>";\n            finalHtml = finalHtml.split(placeholder).join(imgHtml);\n        }\n    }\n\n    const h1Match = finalHtml.match(/<h1.*?>(.*?)<\/h1>/i);\n    const finalTitle = h1Match ? h1Match[1].replace(/<[^>]*>/g, '').trim() : target;\n    let bodyWithoutH1 = finalHtml.replace(/<h1.*?>.*?<\/h1>/gi, '');\n    let finalBody = STYLE + '<div class="vue-premium">' + bodyWithoutH1 + disclaimer + '</div>';\n\n    console.log('   ğŸš€ [Post] Blogger í¬ìŠ¤íŒ… ì‹œë„: ' + finalTitle);\n    try {\n        const postRes = await blogger.posts.insert({ blogId: bId, requestBody: { title: finalTitle, content: finalBody, labels, published: pTime.toISOString() } });\n        console.log('   ğŸ‰ [Post] í¬ìŠ¤íŒ… ì„±ê³µ! URL: ' + postRes.data.url);\n    } catch (e) {\n        if (String(e.message).includes('429')) {\n            console.log('   âš ï¸ [Blogger] API í•œë„ ì´ˆê³¼ ê°ì§€. 60ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤...');\n            await new Promise(res => setTimeout(res, 60000));\n            await blogger.posts.insert({ blogId: bId, requestBody: { title: finalTitle, content: finalBody, labels, published: pTime.toISOString() } });\n        } else throw e;\n    }\n    return { title: finalTitle };\n  }\n  async function run() {\n    const config = JSON.parse(fs.readFileSync('cluster_config.json', 'utf8'));\n    console.log('   ğŸ”¥ [System] í´ëŸ¬ìŠ¤í„° ì—”ì§„ ê°€ë™ (Blogger ID: ' + config.blog_id + ')');\n    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);\n    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash' });\n    const auth = new google.auth.OAuth2(process.env.GOOGLE_CLIENT_ID, process.env.GOOGLE_CLIENT_SECRET);\n    auth.setCredentials({ refresh_token: process.env.GOOGLE_REFRESH_TOKEN });\n    const blogger = google.blogger({ version: 'v3', auth });\n    const pool = config.clusters || []; if(!pool.length) { console.log('   âŒ [System] íƒ€ê²Ÿ í‚¤ì›Œë“œ í’€ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.'); return; }\n    const mainSeed = pool.splice(Math.floor(Math.random()*pool.length), 1)[0];\n    console.log('   ğŸ¯ [Target] ì´ë²ˆ ì—°ì¬ í‚¤ì›Œë“œ: ' + mainSeed);\n    await writeAndPost(model, mainSeed, config.blog_lang, blogger, config.blog_id, new Date(), [], 1, 1);\n    console.log('   âœ¨ [Done] ì˜¤ëŠ˜ì˜ í´ëŸ¬ìŠ¤í„° ì—°ì¬ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ!');\n  }\n  run();